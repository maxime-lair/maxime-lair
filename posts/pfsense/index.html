<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="PFSense" /><meta name="author" content="Maxime Lair" /><meta property="og:locale" content="en" /><meta name="description" content="First, It can help, to change keyboard layout in PFSense (will reset at next reboot) kbdcontrol -l /usr/share/syscons/keymaps/[YOUR LOCALE LANGUAGE].iso.kbd" /><meta property="og:description" content="First, It can help, to change keyboard layout in PFSense (will reset at next reboot) kbdcontrol -l /usr/share/syscons/keymaps/[YOUR LOCALE LANGUAGE].iso.kbd" /><link rel="canonical" href="https://maxime-lair.github.io/maxime-lair/posts/pfsense/" /><meta property="og:url" content="https://maxime-lair.github.io/maxime-lair/posts/pfsense/" /><meta property="og:site_name" content="Bin/sh" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-28T19:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="PFSense" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Maxime Lair" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Maxime Lair"},"description":"First, It can help, to change keyboard layout in PFSense (will reset at next reboot) kbdcontrol -l /usr/share/syscons/keymaps/[YOUR LOCALE LANGUAGE].iso.kbd","url":"https://maxime-lair.github.io/maxime-lair/posts/pfsense/","@type":"BlogPosting","headline":"PFSense","dateModified":"2021-12-28T19:00:00+01:00","datePublished":"2021-12-28T19:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://maxime-lair.github.io/maxime-lair/posts/pfsense/"},"@context":"https://schema.org"}</script><title>PFSense | Bin/sh</title><link rel="apple-touch-icon" sizes="180x180" href="/maxime-lair/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/maxime-lair/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/maxime-lair/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/maxime-lair/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/maxime-lair/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Bin/sh"><meta name="application-name" content="Bin/sh"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/maxime-lair/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/maxime-lair/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/maxime-lair/" alt="avatar" class="mx-auto"> <img src="/maxime-lair/assets/img/favicons/avatar.gif" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/maxime-lair/">Bin/sh</a></div><div class="site-subtitle font-italic">Have fun reading</div></div><ul class="w-100"><li class="nav-item"> <a href="/maxime-lair/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/maxime-lair/roadTo/" class="nav-link"> <i class="fa-fw fas fa-road ml-xl-3 mr-xl-3 unloaded"></i> <span>ROAD TO DEVOPS</span> </a><li class="nav-item"> <a href="/maxime-lair/bin-sh/" class="nav-link"> <i class="fa-fw fas fa-tools ml-xl-3 mr-xl-3 unloaded"></i> <span>BIN-SH</span> </a><li class="nav-item"> <a href="/maxime-lair/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/maxime-lair/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/maxime-lair/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/maxime-lair/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/maxime-lair" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/maxime-lair/"> Home </a> </span> <span>PFSense</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>PFSense</h1><div class="post-meta text-muted"><div> By <em> <a href="https://github.com/maxime-lair">Maxime Lair</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2021-12-28 19:00:00 +0100" data-toggle="tooltip" data-placement="bottom" title="Tue, Dec 28, 2021, 7:00 PM +0100" >Dec 28, 2021</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1591 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>First, It can help, to change keyboard layout in PFSense (will reset at next reboot) <code class="language-plaintext highlighter-rouge">kbdcontrol -l /usr/share/syscons/keymaps/[YOUR LOCALE LANGUAGE].iso.kbd</code></p><h2 id="wanlan-configuration">WAN/LAN configuration<a href="#wanlan-configuration" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>WAN is the wide area network, and is often considered the “outside” network. Internet is a <em>type</em> of WAN, but It could be your entire company network. It usually means “this is a network which has no finite geographical limit, systems could be anywhere in the world”.</p><p>We want this WAN to be able to access the Internet in our case, and our main objective is to ping a popular DNS IP (like cloudfare 1.1.1.1 or google 8.8.8.8) and receives a response back. This means checking for ICMP filtering, and having a public IP.</p><p>For this, we will be running this inside an hypervisor called ESXi, and with several public IPs provided by my service provider (I bought a whole block, registered to RIPE).</p><p>First, let’s create our network bridge. We want our private network to be able to reach public network, but we don’t want random public network to poll our private network. That means they need to communicate through a firewall, that’s PFSense.</p><p>First, our public network is defined with this IP block, this is what I was assigned to:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>Public IP:  141.95.187.105

Gateway:    141.95.187.110

Netmask:    255.255.255.248 (/29)
</pre></table></code></div></div><p>We now have two choices:</p><ul><li>Create our PFSense, assign it this IP and create two VLANs that will act as WAN and LAN.<li>Create <em>vNIC</em> together with <em>vSwitch</em> in our hypervisor ESXi that will act as our LAN network.</ul><p>Question is: do we create our LAN network at the hypervisor level, or VM level ? Both could work (see <em>router on a stick</em>) But It’s recommended to create them at the hypervisor level, as It makes it way easier to create new VMs in this LAN network, and in PFSense, you can restart one network adapter without bothering the other.</p><p>So let’s create our <em>vSwitch</em> and <em>vNic</em>, check out <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/network/nic-switches">this post to understand why <em>Nic</em> are needed</a></p><p>We create our vSwitch by indicating which uplink we want (physical network adapter on ESXi), I have two availables:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147661859-53af1ae4-6eb3-42fe-a7c9-38348c4a1b6d.png" alt="image" data-proofer-ignore></p><p>One is used for the ESXi management (<em>vmnic0</em>), the other is free to use, so we create our <em>vSwitch</em> named <em>vSwitchLab</em>:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147661940-9ed21d75-b6a1-4197-8201-d3a6d909dd74.png" alt="image" data-proofer-ignore></p><p><img data-src="https://user-images.githubusercontent.com/72258375/147661994-8d5c0fa9-dce1-418e-ae38-68e2de19c57c.png" alt="image" data-proofer-ignore></p><p>Then we create a port groups, that will be standing behind this vSwitch, we call it <em>Lab Network</em></p><p><img data-src="https://user-images.githubusercontent.com/72258375/147662061-d0db6857-5895-4046-88c9-89a6a9ddec93.png" alt="image" data-proofer-ignore></p><p>and we create our <em>vNic</em> to stand on the other side:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147662181-4d56ec89-9082-425f-a586-9d99e5fa2ea1.png" alt="image" data-proofer-ignore></p><p>You might notice It created an IP automatically : <em>192.168.1.100</em> - It is a <a href="https://www.arin.net/reference/research/statistics/address_filters/">private network</a></p><p>And now, we are ready to create our PFSense VM, with two network adapters :</p><ul><li>One for our WAN<li>One for our LAN</ul><p><img data-src="https://user-images.githubusercontent.com/72258375/147662504-1990c282-fcae-4164-9c81-bb43b427cdf8.png" alt="image" data-proofer-ignore></p><p>One detail to note, we need to assign a MAC address on our outside-facing network card, as It will be facing the Internet. This MAC address will be linked with our public IP.</p><p>On this first network adapter, we use “Advanced…” and assign its MAC address. One detail is If we create VLAN from this network adapter, they will all share the same MAC address.</p><p>Now we can start our PFSense, and after installation, we are greeted by this menu:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147663049-467c177f-c1e6-42d9-8e63-a1bfdc133937.png" alt="image" data-proofer-ignore></p><p>We want to first assign interfaces, and then set our interface(s) IP address.</p><p>When assigning interfaces, we want:</p><ul><li>em0 (VM Network) to be our WAN<li>em1 (Lab Network) to be our LAN</ul><p>Do not create any VLAN or downgrade the console to http, It is not needed.</p><p>Then we set our IPs, they are static on both sides, since we do not have a DHCP server assigning them:</p><ul><li>em0 &lt;-&gt; WAN &lt;-&gt; Public IP: 141.95.187.105/29 with gateway 141.95.187.110<li>em1 &lt;-&gt; LAN &lt;-&gt; Private IP: 10.0.0.1/24 (<a href="https://en.wikipedia.org/wiki/Private_network">could have used up to /8</a>) with no gateway (as we are our own gateway)</ul><p>I could have used any IP in available private subnets : 10.0.0.0/8, 172.16.0.0/12 or 192.168.0.0/16</p><p>Let’s try to ping an outside of network DNS:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147663682-59107466-1e1d-4677-a25c-de4dc7a71040.png" alt="image" data-proofer-ignore></p><p>Our firewall is able to ping outside network, all is left is to create a VM with a GUI in the LAN network to reach PFSense web interface, and have it able to reach outside network by going through our PFSense firewall.</p><h1 id="installing-a-lab-in-our-lan">Installing a lab in our LAN</h1><h2 id="network-connectivity">Network connectivity<a href="#network-connectivity" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="reasoning">Reasoning<a href="#reasoning" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p><em>Note:</em> I will be using a CentOS 9 Stream, which came out this month.</p><p>When creating the VM in ESXi, create a network adapter assigned to “Lab Network”</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147664021-1c129243-ad32-4a2f-aeb2-e3a500aeb778.png" alt="image" data-proofer-ignore></p><p>After installing our OS, our system is unable to connect to its network. This is normal as he doesn’t have a DHCP server to give him his IP, we have to manually set it up.</p><p>For this, I will be using <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-configuring_ip_networking_with_nmcli">NetworkManager CLI</a>, also named <em>nmcli</em>, as It’s better suited for scripting and I want to test it out. Others setups will probably prefer using configuration files, and that would have been my first choice had I not decided to try out this CLI.</p><p>My end goal would be to include the next commands in my Ansible playbook when I want to create more VMs.</p><h3 id="set-up-static-ip-through-nmcli">Set up static IP through nmcli<a href="#set-up-static-ip-through-nmcli" class="anchor"><i class="fas fa-hashtag"></i></a></h3></h3><p>First, we check which devices we will use:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147653668-df93e522-1b04-426c-88d9-46ba7043ffa2.png" alt="image" data-proofer-ignore></p><p><em>ens32</em> will be our dedicated device. Here <code class="language-plaintext highlighter-rouge">nmcli dev</code> stands for <code class="language-plaintext highlighter-rouge">nmcli device status</code> - It’s a nice shortcut.</p><p>It’s possible to create this device through <code class="language-plaintext highlighter-rouge">nmcli</code> but we already did that when creating the VM.</p><p>Our network, as defined in PFSense, will look like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Network:    10.0.0.0/24

Gateway:    10.0.0.1

Broadcast:  10.0.0.255

Mask(/24):  255.255.255.0
</pre></table></code></div></div><p>Since this is our first system we set up in this network, let’s just increment and use the first available IP: <em>10.0.0.2</em></p><p>For others installations, we will try to have a DHCP server to assign this automatically.</p><p><code class="language-plaintext highlighter-rouge">nmcli connection modify ens32 ipv4.addresses "10.0.0.2/24" ipv4.gateway "10.0.0.1 ipv4.method "manual" ipv4.dns "10.0.0.1"</code></p><p>Our device is now set with his static IP, and indicating the gateway creates the route. Be careful as the default connection is usually with DHCP activated (<em>ipv4.method</em> set to manual instead of auto)</p><p>If you need to check all availables variables, check out your configuration in <em>/etc/NetworkManager/system-connections/[CON-NAME].nmconnection</em></p><p><img data-src="https://user-images.githubusercontent.com/72258375/147657723-2db5567d-506f-4e7a-98c6-4ffee165bd38.png" alt="image" data-proofer-ignore></p><p>All green, all good ! Let’s try to ping our gateway:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147660146-97aceaac-1987-4702-9719-1777c5a1d0c9.png" alt="image" data-proofer-ignore></p><p>Naturally, It works, as we are in the same LAN as defined on ESXi and our VM configuration. But can we reach outside network ?</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147660237-f9bac85e-4a28-458e-a9fc-523d748f42d3.png" alt="image" data-proofer-ignore></p><p>We can, great ! If that didn’t work, we could have looked into the ICMP traffic, if PFSense was rejecting them by default.</p><p>Now we can connect to PFSense GUI and start enhancing our setup from our CentOS in LAN</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147660324-97cd4a87-2a9d-45ac-af3a-1a398039fee7.png" alt="image" data-proofer-ignore></p><p>By default, this GUI is only available on the LAN side, as to not expose it to outside network (<a href="https://www.shodan.io/search?query=pfsense">how easy would It be to scan IPs for PFSense first install</a>).</p><p>Default user is <em>admin</em> / <em>pfsense</em></p><p>And we are good to go !</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147664313-394962d8-bf62-471a-acba-9490dcf5ca42.png" alt="image" data-proofer-ignore></p><p>All is left is to add some firewall rules, create new VMs in this network, and we are all set !</p><p>We end up with this infrastructure:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147668332-6befe267-9e69-45ef-808b-11ae498df370.png" alt="image" data-proofer-ignore></p><p>Lanlab(s) will be used to host kubernetes nodes, and esxi-lab is here for quick services testing.</p><p>For next hosts, we can rename them with</p><p><code class="language-plaintext highlighter-rouge">hostnamectl set-hostname lanlabX</code></p><p>Then reboot.</p><p>If you can’t resolve DNS entry (you can <code class="language-plaintext highlighter-rouge">wget http://1.1.1.1</code> but not <code class="language-plaintext highlighter-rouge">wget http://google.com</code>), check your configuration in <em>/etc/resolv.conf</em> ; I had to reboot on mine, even though <em>nmcli</em> worked on others hosts..</p><h1 id="configuring-pfsense">Configuring PFSense</h1><p>Now that we have a working traffic network, we need to set up some policies.</p><p>Let’s use PFSense GUI -&gt; System -&gt; Setup Wizard</p><p>We don’t have anything to change, besides maybe your DNS server, just make sure on <em>step 4/9</em> to select Static and not DHCP.</p><p>Next, we want to set up SSH tunneling, so we can SSH from a remote terminal into our lan-lab networks.</p><p>In System -&gt; Advanced -&gt; Check <em>Enables ssh-agent forwarding support</em> - This will allow us to authenticate with our local RSA key when tunneling instead of PFSense’s one.</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147681744-5b037c58-39f5-4b01-933c-1be9cf0f2173.png" alt="image" data-proofer-ignore></p><p>Don’t forget to remove Password authentication in the long-run and only allow public key authentication.</p><p>Now we need to authorize some ports from WAN into our LAN. You can check out some common skeleton, but It really depends on your infrastructure. As for mine, I’m still modifying it heavily.</p><p>For now, we will just authorize SSH connections in our network.</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147689395-42b60966-e39a-4001-b4e0-c953cd8ddd08.png" alt="image" data-proofer-ignore></p><h2 id="ssh-tunneling">SSH Tunneling<a href="#ssh-tunneling" class="anchor"><i class="fas fa-hashtag"></i></a></h2></h2><p>We want to connect from a remote terminal in our lanlab systems, we will try to connect through a SSH tunnel by bouncing off PFSense into our Lab network.</p><p>We will be using our <code class="language-plaintext highlighter-rouge">~/.ssh/rsa_pub.key</code> from our local terminal.</p><p>We go back on PFSense, and on the GUI (<em>User Manager -&gt; Edit -&gt; Authorized SSH Keys</em>), we add our key (you could also add it through the terminal).</p><p>Since our plan is : (Local Terminal) –&gt; (PFSense) –&gt; (Remote lab), we will use <code class="language-plaintext highlighter-rouge">ssh -J USER@PFSENSE USER@LAB</code></p><p><img data-src="https://user-images.githubusercontent.com/72258375/147690252-f61252d7-1b93-4e21-bd14-ba38b93635f4.png" alt="image" data-proofer-ignore></p><p>Of course we could use a ProxyCommand file to avoid using this jump everytime. Let’s disable password authentication on PFSense after we have spread our <em>id_rsa.pub</em></p><p>After adding a DNS entry for PFSense (too lazy to remember the IP), I have this configuration for accessing my LAB:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147693089-d59bdb2d-b6ad-4117-9e1b-c38db20e2336.png" alt="image" data-proofer-ignore></p><p>I can’t use DNS entries for the systems inside the LAB, as PFSense can’t make the link between it yet (He doesn’t have any DNS or DHCP server with those entries yet).</p><p>Now, we are ready to connect into our infrastructure:</p><p><img data-src="https://user-images.githubusercontent.com/72258375/147693700-565adaba-9dfe-4e52-93ae-683d2a3512ac.gif" alt="Animation" data-proofer-ignore></p><p>This should not be our final setup, as we will want to use OpenVPN at one point instead of this tunnel, and some DHCP/DNS, but It’s working well for now. There is still much more to do with setting up a DEV/UAT/PROD environment.</p><blockquote><p><em>Credits</em></p><p>https://docs.ovh.com/au/en/dedicated/pfSense-bridging/#requirements</p><p>https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/networking_guide/sec-configuring_ip_networking_with_nmcli</p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/maxime-lair/categories/projectbob/'>ProjectBob</a>, <a href='/maxime-lair/categories/infrastructure/'>Infrastructure</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/maxime-lair/tags/linux/" class="post-tag no-text-decoration" >linux</a> <a href="/maxime-lair/tags/pfsense/" class="post-tag no-text-decoration" >pfsense</a> <a href="/maxime-lair/tags/network/" class="post-tag no-text-decoration" >network</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=PFSense - Bin/sh&url=https://maxime-lair.github.io/maxime-lair/posts/pfsense/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recent Update</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/maxime-lair/posts/sockets/">Sockets</a><li><a href="/maxime-lair/posts/networking_concepts/">Networking concepts</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/maxime-lair/tags/linux/">linux</a> <a class="post-tag" href="/maxime-lair/tags/bash/">bash</a> <a class="post-tag" href="/maxime-lair/tags/initd/">initd</a> <a class="post-tag" href="/maxime-lair/tags/network/">network</a> <a class="post-tag" href="/maxime-lair/tags/bus/">bus</a> <a class="post-tag" href="/maxime-lair/tags/cadvisor/">cadvisor</a> <a class="post-tag" href="/maxime-lair/tags/concurrency/">concurrency</a> <a class="post-tag" href="/maxime-lair/tags/container/">container</a> <a class="post-tag" href="/maxime-lair/tags/device/">device</a> <a class="post-tag" href="/maxime-lair/tags/docker/">docker</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/maxime-lair/posts/networking_concepts/"><div class="card-body"> <em class="timeago small" date="2022-01-11 19:00:00 +0100" >Jan 11, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Networking concepts</h3><div class="text-muted small"><p> In this article, we will try to focus on the layer 2 and 3 of the OSI model. We will try to understand IP v4/v6 works without diving too much into details, and understand how It is routed across n...</p></div></div></a></div><div class="card"> <a href="/maxime-lair/posts/docker_introduction/"><div class="card-body"> <em class="timeago small" date="2021-12-26 19:00:00 +0100" >Dec 26, 2021</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Docker introduction</h3><div class="text-muted small"><p> This article is the first introduction to docker, and how to run containers on a single host. The end-goal is to have an infrastructure running several services: Setup docker and docker-compose...</p></div></div></a></div><div class="card"> <a href="/maxime-lair/posts/memory_and_storage/"><div class="card-body"> <em class="timeago small" date="2022-01-03 19:00:00 +0100" >Jan 3, 2022</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Memory and storage</h3><div class="text-muted small"><p> In this article, we will take a look at how memory and storage interact in Linux, the different technology available, and their perks and defaults Note: Im running a CentOS9 Stream in this article...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/maxime-lair/posts/tmux/" class="btn btn-outline-primary" prompt="Older"><p>Tmux</p></a> <a href="/maxime-lair/posts/process_management/" class="btn btn-outline-primary" prompt="Newer"><p>Process Management</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/maxime-lair">Maxime Lair</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/maxime-lair/tags/linux/">linux</a> <a class="post-tag" href="/maxime-lair/tags/bash/">bash</a> <a class="post-tag" href="/maxime-lair/tags/initd/">initd</a> <a class="post-tag" href="/maxime-lair/tags/network/">network</a> <a class="post-tag" href="/maxime-lair/tags/bus/">bus</a> <a class="post-tag" href="/maxime-lair/tags/cadvisor/">cadvisor</a> <a class="post-tag" href="/maxime-lair/tags/concurrency/">concurrency</a> <a class="post-tag" href="/maxime-lair/tags/container/">container</a> <a class="post-tag" href="/maxime-lair/tags/device/">device</a> <a class="post-tag" href="/maxime-lair/tags/docker/">docker</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/maxime-lair/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/maxime-lair/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/maxime-lair/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
